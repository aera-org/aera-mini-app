## User Flow

1. **Welcome Screen:**

   - Displays the game title, description, and a prominent "Play" button.
   - Automatically detects if the app is launched within Telegram.

2. **Telegram Authentication:**

   - When launched via Telegram, the app extracts initialization data (`initData`) from `window.Telegram.WebApp`.
   - The extracted data is sent to the backend for validation.

**TON Wallet Connection Guide**

Below is a step-by-step guide on how to integrate TonConnect into your application, handle wallet connections, and validate proofs on the backend.

1. Initial Setup
   In your main application file (e.g., App.tsx), wrap your app with the TonConnectUIProvider. Make sure to provide the correct manifestUrl, which points to your tonconnect-manifest.json file:

```typescript
// In App.tsx
<TonConnectUIProvider manifestUrl="https://your-domain.com/tonconnect-manifest.json">
  <App />
</TonConnectUIProvider>
```

2. Connection Flow
   Hereâ€™s an example of how to handle the wallet connection and proof generation:

```typescript
// 1. Generate nonce from the backend
const nonce = await walletApi.generateNonce();
```

```typescript
// 2. Connect the wallet and request proof
const wallet = useTonWallet();
const [tonConnect] = useTonConnectUI();
```

```typescript
// 3. Check the connection and proof
if (wallet?.connectItems?.tonProof && !('error' in wallet.connectItems.tonProof)) {
const proof = wallet.connectItems.tonProof.proof;
const account = {
address: wallet.account.address,
walletStateInit: wallet.account.walletStateInit
};
```

```typescript

// 4. Send the proof and account info to the backend for validation
await walletApi.connectWallet(proof, account, userId);
}
```

```typescript
// 1. Generate nonce from the backend
const nonce = await walletApi.generateNonce();
```

```typescript
// 2. Connect the wallet and request proof
const wallet = useTonWallet();
const [tonConnect] = useTonConnectUI();
```

```typescript
// 3. Check the connection and proof
if (wallet?.connectItems?.tonProof && !('error' in wallet.connectItems.tonProof)) {
const proof = wallet.connectItems.tonProof.proof;
const account = {
address: wallet.account.address,
walletStateInit: wallet.account.walletStateInit
};

```

```typescript
// 4. Send the proof and account info to the backend for validation
await walletApi.connectWallet(proof, account, userId);
}
```

Explanation:

Generate nonce: The server provides a unique nonce (e.g., a random string) that the wallet needs to sign.
Connect wallet: Use TonConnectUI to prompt the user to connect their wallet and provide proof.
Check proof: Once the wallet is connected, check if wallet.connectItems.tonProof exists.
Backend validation: Send the proof and account data (address, walletStateInit) to your backend to verify the signature.

3. Backend Validation
   Your backend expects certain fields from the proof and account:

```typescript
interface TonProof {
  name: string; // 'ton_proof'
  payload: string; // The nonce from the backend
}
```

```typescript
interface TonAccount {
  address: string; // Wallet address
  walletStateInit: string; // Wallet state init data
}

// Response structure
interface WalletResponse {
  success: boolean;
  address?: {
    user_id: number;
    friendly_address: string;
    technical_address: string;
  };
  error?: string;
}
```

Key points:

name should be 'ton_proof'.

payload must match the nonce generated by the backend.
The backend should verify the signature in proof to ensure the user truly owns the wallet.

4. Key Points Recap
   Generate nonce on the backend.
   Connect the wallet using TonConnect.
   Obtain the proof from the connected wallet.
   Send proof and wallet info to the backend for validation.
   Store connection state (e.g., in localStorage) to remember if the user is connected.
   Disconnect properly by clearing stored data (e.g., removing connectedWallet from localStorage).

5. Error Handling

Use a try/catch block to handle any connection or proof errors:

```typescript
try {
if (!wallet?.connectItems?.tonProof) {
throw new Error('No proof provided');
}
// Connection logic here
} catch (err) {
await tonConnect.disconnect();
setError(err.message);
}

6. Storing Connection State
   When the wallet is successfully connected, store a flag in localStorage to persist the connection:

// On successful connection
localStorage.setItem('connectedWallet', 'true');

// On disconnect
localStorage.removeItem('connectedWallet');

When the user disconnects, remove the flag:

// On disconnect
localStorage.removeItem('connectedWallet');
```

This ensures your UI knows whether a wallet is connected across page reloads or sessions.
